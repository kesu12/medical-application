<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assignment Management - Medical App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0b1020; color: #e7ecf5; }
    .topbar { display:flex; align-items:center; justify-content:space-between; padding:14px 20px; background:#121a33; border-bottom:1px solid #1f2a4a; }
    .container { padding: 20px; max-width: 1400px; margin: 0 auto; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .card { background:#121a33; border:1px solid #1f2a4a; border-radius:12px; padding:20px; }
    .btn { appearance:none; border:1px solid #2b3a63; background:#1a2444; color:#e7ecf5; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.2s; }
    .btn:hover { background:#2b3a63; }
    .btn.primary { background:#2c6bed; border-color:#2c6bed; }
    .btn.primary:hover { background:#1e5bb8; }
    .btn.success { background:#10b981; border-color:#10b981; }
    .btn.success:hover { background:#059669; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #9aacc8; }
    .form-group input, .form-group select { width: 100%; background:#0e1630; border:1px solid #1f2a4a; color:#e7ecf5; padding:10px 12px; border-radius:8px; box-sizing: border-box; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #2c6bed; }
    .table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #1f2a4a; }
    .table th { background: #1a2444; font-weight: 600; color: #9aacc8; }
    .table tr:hover { background: #1a2444; }
    .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
    .status.confirmed { background: #10b981; color: white; }
    .status.unconfirmed { background: #f59e0b; color: white; }
    .status.deactivated { background: #ef4444; color: white; }
    .alert { padding: 12px; border-radius: 8px; margin-bottom: 16px; }
    .alert.success { background: #10b981; color: white; }
    .alert.error { background: #ef4444; color: white; }
    .alert.info { background: #3b82f6; color: white; }
    .hidden { display: none; }
    
    /* Tabs styles */
    .tabs { display: flex; border-bottom: 1px solid #1f2a4a; margin-bottom: 20px; }
    .tab { padding: 12px 24px; background: #1a2444; border: 1px solid #1f2a4a; border-bottom: none; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .tab:first-child { border-top-left-radius: 8px; }
    .tab:last-child { border-top-right-radius: 8px; }
    .tab:hover { background: #2b3a63; }
    .tab.active { background: #2c6bed; border-color: #2c6bed; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Full width table */
    .full-width-table { grid-column: 1 / -1; }
  </style>
</head>
<body>
  <div class="topbar">
  <div>Assignment Management</div>
    <div>
    <a class="btn" href="/admin">Admin Panel</a>
    <a class="btn" href="/dashboard">Dashboard</a>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="container">
  <div id="alertContainer"></div>
  
  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('doctor-department')">Назначение отделов врачам</div>
    <div class="tab" onclick="switchTab('nurse-patient')">Назначение медсестер пациентам</div>
    <div class="tab" onclick="switchTab('doctor-patient')">Назначение врачей пациентам</div>
  </div>

  <!-- Doctor Department Assignment Tab -->
  <div id="doctor-department" class="tab-content active">
    <div class="grid">
    <div class="card">
        <h3>Назначить отдел врачу</h3>
        <form id="assignDepartmentForm">
          <div class="form-group">
            <label for="doctorSelect">Выберите врача:</label>
            <select id="doctorSelect" required>
              <option value="">-- Выберите врача --</option>
            </select>
        </div>
          <div class="form-group">
            <label for="departmentSelect">Выберите отдел:</label>
            <select id="departmentSelect" required>
              <option value="">-- Выберите отдел --</option>
            </select>
        </div>
          <button type="submit" class="btn primary">Назначить отдел</button>
        </form>
        </div>

      <div class="card">
        <h3>Текущие назначения отделов</h3>
        <div class="form-group">
          <button class="btn" id="refreshDoctorAssignments">Обновить список</button>
        </div>
        <div id="doctorAssignmentsTable">
          <table class="table">
            <thead>
              <tr>
                <th>Врач</th>
                <th>Отдел</th>
                <th>Статус</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="doctorAssignmentsBody">
              <tr>
                <td colspan="4" style="text-align: center; color: #9aacc8;">Загрузка...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
      </div>

  <!-- Nurse to Patient Assignment Tab -->
  <div id="nurse-patient" class="tab-content">
    <div class="grid">
      <div class="card">
        <h3>Назначить медсестру пациенту</h3>
        <form id="assignNurseForm">
            <div class="form-group">
            <label for="patientSelectNurse">Выберите пациента:</label>
            <select id="patientSelectNurse" required>
              <option value="">-- Выберите пациента --</option>
              </select>
            </div>
            <div class="form-group">
            <label for="nurseSelect">Выберите медсестру:</label>
            <select id="nurseSelect" required>
              <option value="">-- Выберите медсестру --</option>
              </select>
          </div>
          <button type="submit" class="btn primary">Назначить медсестру</button>
        </form>
      </div>

      <div class="card">
        <h3>Текущие назначения медсестер</h3>
        <div class="form-group">
          <button class="btn" id="refreshNurseAssignments">Обновить список</button>
        </div>
        <div id="nurseAssignmentsTable">
          <table class="table">
            <thead>
              <tr>
                <th>Пациент</th>
                <th>Медсестра</th>
                <th>Отдел</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="nurseAssignmentsBody">
              <tr>
                <td colspan="4" style="text-align: center; color: #9aacc8;">Загрузка...</td>
              </tr>
            </tbody>
          </table>
            </div>
            </div>
          </div>
        </div>

  <!-- Doctor to Patient Assignment Tab -->
  <div id="doctor-patient" class="tab-content">
    <div class="grid">
      <div class="card">
        <h3>Назначить врача пациенту</h3>
        <form id="assignDoctorForm">
            <div class="form-group">
            <label for="patientSelectDoctor">Выберите пациента:</label>
            <select id="patientSelectDoctor" required>
              <option value="">-- Выберите пациента --</option>
              </select>
            </div>
            <div class="form-group">
            <label for="doctorSelectPatient">Выберите врача:</label>
            <select id="doctorSelectPatient" required>
              <option value="">-- Выберите врача --</option>
              </select>
          </div>
          <button type="submit" class="btn primary">Назначить врача</button>
        </form>
      </div>

      <div class="card">
        <h3>Текущие назначения врачей</h3>
        <div class="form-group">
          <button class="btn" id="refreshDoctorPatientAssignments">Обновить список</button>
        </div>
        <div id="doctorPatientAssignmentsTable">
          <table class="table">
            <thead>
              <tr>
                <th>Пациент</th>
                <th>Врач</th>
                <th>Отдел</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="doctorPatientAssignmentsBody">
              <tr>
                <td colspan="4" style="text-align: center; color: #9aacc8;">Загрузка...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- All Users Table (visible on all tabs) -->
  <div class="card full-width-table" style="margin-top: 20px;">
    <h3>Все пользователи</h3>
    <div class="form-group">
      <button class="btn" id="refreshUsers">Обновить список пользователей</button>
    </div>
    <div id="usersTable">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Имя пользователя</th>
            <th>Имя</th>
            <th>Фамилия</th>
            <th>Роль</th>
            <th>Отдел</th>
            <th>Назначенная медсестра</th>
            <th>Назначенный врач</th>
            <th>Статус</th>
          </tr>
        </thead>
        <tbody id="usersBody">
          <tr>
            <td colspan="9" style="text-align: center; color: #9aacc8;">Загрузка...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="/js/api.js"></script>
<script>
  if (!AppApi.isLoggedIn()) location.href = '/signin';
  
  // Check if user is admin
  async function checkAdminAccess() {
    try {
      const res = await AppApi.apiGet('/api/admin/users');
      if (!res.ok) {
        showAlert('Доступ запрещен. Только администраторы могут использовать эту страницу.', 'error');
        setTimeout(() => {
          location.href = '/dashboard';
        }, 3000);
        return false;
      }
      return true;
    } catch (error) {
      showAlert('Ошибка проверки прав доступа: ' + error.message, 'error');
      setTimeout(() => {
        location.href = '/dashboard';
      }, 3000);
      return false;
    }
  }

  document.getElementById('logoutBtn').onclick = async () => { 
    await AppApi.logout(); 
    location.href = '/signin'; 
  };

  // Tab switching function
  function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName).classList.add('active');
    
    // Add active class to clicked tab
    event.target.classList.add('active');
  }

  // Show alert function
  function showAlert(message, type = 'info') {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert ${type}`;
    alert.textContent = message;
    alertContainer.appendChild(alert);
    
    setTimeout(() => {
      alert.remove();
    }, 5000);
  }

  // Load doctors
  async function loadDoctors() {
    try {
      const res = await AppApi.apiGet('/api/assignments/all-doctors');
      if (res.ok) {
        const doctors = await res.json();
        
        // Populate doctor selects
        const doctorSelects = ['doctorSelect', 'doctorSelectPatient'];
        doctorSelects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
            select.innerHTML = '<option value="">-- Выберите врача --</option>';
            doctors.forEach(doctor => {
              const option = document.createElement('option');
              option.value = doctor.userId;
              option.textContent = `${doctor.firstName || ''} ${doctor.lastName || ''} (${doctor.username})`;
              select.appendChild(option);
            });
          }
        });
      }
    } catch (error) {
      showAlert('Ошибка загрузки врачей: ' + error.message, 'error');
    }
      }

      // Load nurses
  async function loadNurses() {
    try {
      const res = await AppApi.apiGet('/api/assignments/all-nurses');
      if (res.ok) {
        const nurses = await res.json();
        const select = document.getElementById('nurseSelect');
        select.innerHTML = '<option value="">-- Выберите медсестру --</option>';
        
        nurses.forEach(nurse => {
          const option = document.createElement('option');
          option.value = nurse.userId;
          option.textContent = `${nurse.firstName || ''} ${nurse.lastName || ''} (${nurse.username})`;
          select.appendChild(option);
        });
      }
    } catch (error) {
      showAlert('Ошибка загрузки медсестер: ' + error.message, 'error');
    }
  }

  // Load patients
  async function loadPatients() {
    try {
      const res = await AppApi.apiGet('/api/assignments/active-patients');
      if (res.ok) {
        const patients = await res.json();
        
        // Populate patient selects
        const patientSelects = ['patientSelectNurse', 'patientSelectDoctor'];
        patientSelects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
            select.innerHTML = '<option value="">-- Выберите пациента --</option>';
            patients.forEach(patient => {
              const option = document.createElement('option');
              option.value = patient.userId;
              option.textContent = `${patient.firstName || ''} ${patient.lastName || ''} (${patient.username})`;
              select.appendChild(option);
            });
          }
        });
      }
    } catch (error) {
      showAlert('Ошибка загрузки пациентов: ' + error.message, 'error');
    }
  }

  async function loadDepartments() {
    try {
      const res = await AppApi.apiGet('/api/admin/department/all');
      if (res.ok) {
        const departments = await res.json();
        const select = document.getElementById('departmentSelect');
        select.innerHTML = '<option value="">-- Выберите отдел --</option>';
        
        departments.forEach(dept => {
      const option = document.createElement('option');
          option.value = dept.id;
          option.textContent = dept.name;
      select.appendChild(option);
    });
  }
    } catch (error) {
      showAlert('Ошибка загрузки отделов: ' + error.message, 'error');
    }
  }

  // Load doctor department assignments
  async function loadDoctorAssignments() {
    try {
      const res = await AppApi.apiGet('/api/assignments/all-doctors');
      if (res.ok) {
        const doctors = await res.json();
        const tbody = document.getElementById('doctorAssignmentsBody');
        tbody.innerHTML = '';
        
        doctors.forEach(doctor => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${doctor.firstName || ''} ${doctor.lastName || ''} (${doctor.username})</td>
            <td>${doctor.department ? doctor.department.name : 'Не назначен'}</td>
            <td><span class="status ${doctor.confirmed ? 'confirmed' : 'unconfirmed'}">${doctor.confirmed ? 'Подтвержден' : 'Не подтвержден'}</span></td>
            <td>
              <button class="btn" onclick="changeDoctorDepartment(${doctor.userId})" style="padding: 4px 8px; font-size: 12px;">
                ${doctor.department ? 'Изменить отдел' : 'Назначить отдел'}
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }
    } catch (error) {
      showAlert('Ошибка загрузки назначений отделов: ' + error.message, 'error');
    }
  }

  // Load nurse assignments
  async function loadNurseAssignments() {
    try {
      const res = await AppApi.apiGet('/api/assignments/active-patients');
      if (res.ok) {
        const patients = await res.json();
        const tbody = document.getElementById('nurseAssignmentsBody');
        tbody.innerHTML = '';
        
        patients.forEach(patient => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${patient.firstName || ''} ${patient.lastName || ''} (${patient.username})</td>
            <td>${patient.assignedNurse ? `${patient.assignedNurse.firstName || ''} ${patient.assignedNurse.lastName || ''} (${patient.assignedNurse.username})` : 'Не назначена'}</td>
            <td>${patient.department ? patient.department.name : 'Не назначен'}</td>
            <td>
              <button class="btn" onclick="changeNurseAssignment(${patient.userId})" style="padding: 4px 8px; font-size: 12px;">
                ${patient.assignedNurse ? 'Изменить медсестру' : 'Назначить медсестру'}
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }
    } catch (error) {
      showAlert('Ошибка загрузки назначений медсестер: ' + error.message, 'error');
    }
  }

  // Load doctor patient assignments
  async function loadDoctorPatientAssignments() {
    try {
      const res = await AppApi.apiGet('/api/assignments/active-patients');
      if (res.ok) {
        const patients = await res.json();
        const tbody = document.getElementById('doctorPatientAssignmentsBody');
        tbody.innerHTML = '';
        
        patients.forEach(patient => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${patient.firstName || ''} ${patient.lastName || ''} (${patient.username})</td>
            <td>${patient.assignedDoctor ? `${patient.assignedDoctor.firstName || ''} ${patient.assignedDoctor.lastName || ''} (${patient.assignedDoctor.username})` : 'Не назначен'}</td>
            <td>${patient.department ? patient.department.name : 'Не назначен'}</td>
            <td>
              <button class="btn" onclick="changeDoctorAssignment(${patient.userId})" style="padding: 4px 8px; font-size: 12px;">
                ${patient.assignedDoctor ? 'Изменить врача' : 'Назначить врача'}
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }
    } catch (error) {
      showAlert('Ошибка загрузки назначений врачей: ' + error.message, 'error');
    }
  }

  // Load all users
  async function loadUsers() {
    try {
      const res = await AppApi.apiGet('/api/assignments/all-users');
      if (res.ok) {
        const users = await res.json();
        const tbody = document.getElementById('usersBody');
        tbody.innerHTML = '';
        
        users.forEach(user => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.userId}</td>
            <td>${user.username}</td>
            <td>${user.firstName || ''}</td>
            <td>${user.lastName || ''}</td>
            <td>${user.role}</td>
            <td>${user.department ? user.department.name : 'Не назначен'}</td>
            <td>${user.assignedNurse ? `${user.assignedNurse.firstName || ''} ${user.assignedNurse.lastName || ''}` : 'Не назначена'}</td>
            <td>${user.assignedDoctor ? `${user.assignedDoctor.firstName || ''} ${user.assignedDoctor.lastName || ''}` : 'Не назначен'}</td>
            <td><span class="status ${user.confirmed ? 'confirmed' : 'unconfirmed'}">${user.confirmed ? 'Подтвержден' : 'Не подтвержден'}</span></td>
          `;
          tbody.appendChild(row);
        });
      }
    } catch (error) {
      showAlert('Ошибка загрузки пользователей: ' + error.message, 'error');
    }
  }

  // Assign department form
  document.getElementById('assignDepartmentForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const doctorId = document.getElementById('doctorSelect').value;
    const departmentId = document.getElementById('departmentSelect').value;
    
    if (!doctorId || !departmentId) {
      showAlert('Пожалуйста, выберите врача и отдел', 'error');
      return;
    }
    
    try {
      const res = await AppApi.apiPatch(`/api/admin/users/${doctorId}/assign-department`, { 
        departmentId: parseInt(departmentId) 
      });
      
      if (res.ok) {
        const result = await res.json();
        showAlert(`Отдел успешно назначен врачу ${result.firstName} ${result.lastName}`, 'success');
        loadDoctorAssignments();
        loadUsers();
        document.getElementById('assignDepartmentForm').reset();
      } else {
        const error = await res.text();
        showAlert('Ошибка назначения отдела: ' + error, 'error');
      }
    } catch (error) {
      showAlert('Ошибка назначения отдела: ' + error.message, 'error');
    }
  };

  // Assign nurse form
  document.getElementById('assignNurseForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const patientId = document.getElementById('patientSelectNurse').value;
    const nurseId = document.getElementById('nurseSelect').value;
    
    if (!patientId || !nurseId) {
      showAlert('Пожалуйста, выберите пациента и медсестру', 'error');
      return;
    }

    try {
      const res = await AppApi.apiPost(`/api/assignments/patients/${patientId}/nurse`, {
        nurseId: parseInt(nurseId)
      });
      
      if (res.ok) {
        const result = await res.json();
        showAlert(`Медсестра успешно назначена пациенту ${result.firstName} ${result.lastName}`, 'success');
        loadNurseAssignments();
        loadUsers();
        document.getElementById('assignNurseForm').reset();
      } else {
        const error = await res.text();
        showAlert('Ошибка назначения медсестры: ' + error, 'error');
      }
    } catch (error) {
      showAlert('Ошибка назначения медсестры: ' + error.message, 'error');
    }
  };

  // Assign doctor form
  document.getElementById('assignDoctorForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const patientId = document.getElementById('patientSelectDoctor').value;
    const doctorId = document.getElementById('doctorSelectPatient').value;
    
    if (!patientId || !doctorId) {
      showAlert('Пожалуйста, выберите пациента и врача', 'error');
      return;
    }

    try {
      const res = await AppApi.apiPost(`/api/assignments/patients/${patientId}/doctor`, {
        doctorId: parseInt(doctorId)
      });
      
      if (res.ok) {
        const result = await res.json();
        showAlert(`Врач успешно назначен пациенту ${result.firstName} ${result.lastName}`, 'success');
        loadDoctorPatientAssignments();
        loadUsers();
        document.getElementById('assignDoctorForm').reset();
      } else {
        const error = await res.text();
        showAlert('Ошибка назначения врача: ' + error, 'error');
      }
    } catch (error) {
      showAlert('Ошибка назначения врача: ' + error.message, 'error');
    }
  };

  // Refresh buttons
  document.getElementById('refreshDoctorAssignments').onclick = loadDoctorAssignments;
  document.getElementById('refreshNurseAssignments').onclick = loadNurseAssignments;
  document.getElementById('refreshDoctorPatientAssignments').onclick = loadDoctorPatientAssignments;
  document.getElementById('refreshUsers').onclick = loadUsers;

  // Change doctor department function
  async function changeDoctorDepartment(doctorId) {
    const departmentId = prompt('Введите ID нового отдела:');
    if (!departmentId) return;
    
    try {
      const res = await AppApi.apiPatch(`/api/admin/users/${doctorId}/change-department`, { 
        departmentId: parseInt(departmentId)
      });
      
      if (res.ok) {
        const result = await res.json();
        showAlert(`Отдел успешно изменен для врача ${result.firstName} ${result.lastName}`, 'success');
        loadDoctorAssignments();
        loadUsers();
      } else {
        const error = await res.text();
        showAlert('Ошибка изменения отдела: ' + error, 'error');
      }
    } catch (error) {
      showAlert('Ошибка изменения отдела: ' + error.message, 'error');
    }
  }

  // Change nurse assignment function
  async function changeNurseAssignment(patientId) {
    const nurseId = prompt('Введите ID новой медсестры:');
    if (!nurseId) return;
    
    try {
      const res = await AppApi.apiPost(`/api/assignments/patients/${patientId}/nurse`, { 
        nurseId: parseInt(nurseId) 
      });
      
      if (res.ok) {
        const result = await res.json();
        showAlert(`Медсестра успешно изменена для пациента ${result.firstName} ${result.lastName}`, 'success');
        loadNurseAssignments();
        loadUsers();
      } else {
        const error = await res.text();
        showAlert('Ошибка изменения медсестры: ' + error, 'error');
      }
    } catch (error) {
      showAlert('Ошибка изменения медсестры: ' + error.message, 'error');
    }
  }

  // Change doctor assignment function
  async function changeDoctorAssignment(patientId) {
    const doctorId = prompt('Введите ID нового врача:');
    if (!doctorId) return;
    
    try {
      const res = await AppApi.apiPost(`/api/assignments/patients/${patientId}/doctor`, { 
        doctorId: parseInt(doctorId) 
      });
      
      if (res.ok) {
        const result = await res.json();
        showAlert(`Врач успешно изменен для пациента ${result.firstName} ${result.lastName}`, 'success');
        loadDoctorPatientAssignments();
        loadUsers();
      } else {
        const error = await res.text();
        showAlert('Ошибка изменения врача: ' + error, 'error');
      }
    } catch (error) {
      showAlert('Ошибка изменения врача: ' + error.message, 'error');
    }
  }

  // Initial load with admin check
  async function initializePage() {
    const hasAccess = await checkAdminAccess();
    if (hasAccess) {
      loadDoctors();
      loadNurses();
      loadPatients();
      loadDepartments();
      loadDoctorAssignments();
      loadNurseAssignments();
      loadDoctorPatientAssignments();
      loadUsers();
    }
  }

  // Start initialization
  initializePage();
</script>
</body>
</html>